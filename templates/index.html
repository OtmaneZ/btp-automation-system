<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Devis BTP - NFS B√¢timent</title>
    <link rel="icon" type="image/svg+xml" href="/static/img/favicon.svg">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- CSS personnalis√© -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">

    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>

<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header-section">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <img src="/static/img/logo-nfs.png" alt="NFS B√¢timent" class="company-logo me-3">
                    <div>
                        <h1 class="header-title">NFS B√ÇTIMENT</h1>
                        <p class="header-subtitle">G√©n√©rateur de Devis Professionnel</p>
                    </div>
                </div>
                <div class="btn-group">
                    <a href="/qr-code" class="btn btn-outline-success me-2">
                        <i class="fas fa-qrcode me-2"></i>
                        QR Code Clients
                    </a>
                    <a href="/demandes-clients" class="btn btn-outline-info me-2">
                        <i class="fas fa-inbox me-2"></i>
                        Demandes Re√ßues
                    </a>
                    <a href="/historique" class="btn btn-outline-primary">
                        <i class="fas fa-history me-2"></i>
                        Historique des Devis
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Formulaire Principal -->
            <div class="col-lg-8">
                <div class="card fade-in-up">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-file-invoice-dollar text-primary me-2"></i>
                            Nouveau Devis BTP
                            </h5>
                    </div>
                    <div class="card-body">
                        <form id="devisForm">
                            <!-- Informations Client -->
                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-user me-2"></i>
                                    Informations Client
                                </h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Pr√©nom *</label>
                                        <input type="text" class="form-control" id="prenom" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Nom *</label>
                                        <input type="text" class="form-control" id="nom" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Adresse compl√®te *</label>
                                    <textarea class="form-control" id="adresse" rows="2" required></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">T√©l√©phone</label>
                                        <input type="tel" class="form-control" id="telephone">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email">
                                    </div>
                                </div>
                            </div>

                            <!-- Prestations -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-primary mb-0">
                                        <i class="fas fa-cogs me-2"></i>
                                        Prestations BTP
                                    </h6>
                                    <button type="button" class="btn btn-outline-primary btn-sm"
                                        onclick="addPrestation()">
                                        <i class="fas fa-plus me-1"></i>
                                        Ajouter une prestation
                                    </button>
                                </div>
                                <div id="prestations-container">
                                    <!-- Les prestations seront ajout√©es ici -->
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- R√©sum√© et Totaux -->
            <!-- Section R√©sum√© -->
            <div class="col-lg-4">
                <div class="summary-section">
                    <h3 class="summary-title">
                        <i class="fas fa-calculator me-2"></i>
                        R√©sum√© du Devis
                    </h3>

                    <div id="resume-prestations" class="mb-4">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Ajoutez des prestations pour voir le r√©sum√©
                        </div>
                    </div>

                    <div class="summary-row">
                        <span>Total HT:</span>
                        <strong id="total-ht">0,00 ‚Ç¨</strong>
                    </div>
                    <div class="summary-row">
                        <span>TVA (20%):</span>
                        <strong id="total-tva">0,00 ‚Ç¨</strong>
                    </div>
                    <div class="summary-row">
                        <span>Total TTC:</span>
                        <strong id="total-ttc">0,00 ‚Ç¨</strong>
                    </div>

                    <button type="button" class="btn btn-primary btn-lg btn-animated w-100 mt-4"
                        onclick="generateDevis()" id="btn-generate">
                        <i class="fas fa-file-pdf me-2"></i>
                        G√©n√©rer & Envoyer le Devis
                    </button>

                    <!-- Options de r√®glement -->
                    <div class="payment-options-card">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-credit-card me-2"></i>
                            Mode de r√®glement
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Type de r√®glement</label>
                                <select class="form-select" id="payment-mode">
                                    <option value="virement">üí≥ Virement bancaire</option>
                                    <option value="cheque">üìù Ch√®que</option>
                                    <option value="especes">üí∞ Esp√®ces</option>
                                    <option value="cb">üí≥ Carte bancaire</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">√âch√©ance de paiement</label>
                                <select class="form-select" id="payment-deadline">
                                    <option value="reception">√Ä r√©ception</option>
                                    <option value="15j">15 jours</option>
                                    <option value="30j" selected>30 jours</option>
                                    <option value="45j">45 jours</option>
                                    <option value="60j">60 jours</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Options d'envoi -->
                    <div class="email-options-card">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="send-email" checked>
                            <label class="form-check-label" for="send-email">
                                <i class="fas fa-envelope me-2"></i>
                                Envoyer par email au client
                            </label>
                        </div>

                        <!-- S√©lection du template email -->
                        <div id="email-template-section" class="mt-3">
                            <label class="form-label">
                                <i class="fas fa-templates me-2"></i>
                                Template email :
                            </label>
                            <select class="form-select mb-2" id="email-template">
                                <option value="standard">üìß Envoi Standard</option>
                                <option value="signature">‚úçÔ∏è Demande de Signature</option>
                                <option value="relance">üîî Relance Client</option>
                                <option value="accepte">‚úÖ Devis Accept√©</option>
                            </select>

                            <button type="button" class="btn btn-sm btn-outline-primary btn-animated"
                                onclick="previewTemplate()">
                                <i class="fas fa-eye me-1"></i>Aper√ßu
                            </button>
                        </div>

                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Le PDF sera envoy√© automatiquement avec le template s√©lectionn√©
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>

    <!-- Modal Template Preview -->
    <div class="modal fade" id="templateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header gradient-bg">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-envelope me-2"></i>
                        Aper√ßu du Template Email
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold text-primary">
                            <i class="fas fa-tag me-1"></i>
                            Objet :
                        </label>
                        <div class="preview-card" id="preview-subject">
                            <!-- Subject will be filled by JS -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-primary">
                            <i class="fas fa-comment me-1"></i>
                            Message :
                        </label>
                        <div class="preview-card message-preview" id="preview-body" style="white-space: pre-line;">
                            <!-- Body will be filled by JS -->
                        </div>
                    </div>
                    <div class="alert alert-info border-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Les valeurs entre {} seront automatiquement remplac√©es par les donn√©es du client et du
                            devis.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Fermer
                    </button>
                    <button type="button" class="btn btn-primary btn-animated" data-bs-dismiss="modal">
                        <i class="fas fa-check me-1"></i>
                        Utiliser ce Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration EmailJS temporairement d√©sactiv√©e
        // (function () {
        //     emailjs.init("YOUR_PUBLIC_KEY"); // √Ä remplacer par ta cl√© publique EmailJS
        // })();

        console.log('EmailJS d√©sactiv√© temporairement - PDF fonctionne normalement');

        // Donn√©es des prestations disponibles
        const prestationsTypes = {{ prestations | tojson }};
        let prestationCounter = 0;

        // Fonction pour organiser les prestations par cat√©gorie
        function getOptGroupsHTML() {
            const categories = {
                'üß± MA√áONNERIE': ['ma√ßonnerie', 'fondation', 'mur', 'chape', 'enduit', 'dalle', 'muret'],
                'üîß PLOMBERIE': ['plomberie', 'point d\'eau', 'wc', 'lavabo', 'douche', 'baignoire', 'lave'],
                '‚ö° √âLECTRICIT√â': ['√©lectricit√©', 'luminaire', 'prise', 'interrupteur', 'tableau', 'terre', '√©clairage'],
                'üé® PEINTURE': ['peinture', 'lasure', 'papier', 'pr√©paration'],
                'üè† SOLS & CARRELAGE': ['carrelage', 'parquet', 'sol', 'ragr√©age', 'plinthes'],
                'üèóÔ∏è ISOLATION & CLOISONS': ['isolation', 'cloisons', 'placo', 'faux plafond', 'doublage'],
                'üö™ MENUISERIE': ['porte', 'fen√™tre', 'volet', 'placard', 'escalier', 'garde-corps'],
                'üèöÔ∏è COUVERTURE': ['couverture', 'charpente', 'goutti√®res', '√©tanch√©it√©', 'zinguerie'],
                'üî• CHAUFFAGE': ['radiateur', 'chaudi√®re', 'po√™le', 'climatisation', 'plancher chauffant'],
                'üöú TERRASSEMENT': ['terrassement', '√©vacuation', 'remblai', 'raccordement', 'acc√®s'],
                'üî® DIVERS': ['d√©molition', 'nettoyage', 'benne', '√©chafaudage', 'main']
            };

            let html = '<option value="">S√©lectionner...</option>';
            html += '<option value="custom">‚úèÔ∏è Prestation personnalis√©e</option>';

            // Set pour tracker les prestations d√©j√† utilis√©es
            const usedPrestationIds = new Set();

            // Parcourir chaque cat√©gorie
            for (const [categoryName, keywords] of Object.entries(categories)) {
                const categoryItems = [];

                // Trouver les prestations qui correspondent √† cette cat√©gorie
                prestationsTypes.forEach(prestation => {
                    const prestationId = prestation[0];
                    const nom = prestation[1].toLowerCase();

                    // √âviter les doublons et v√©rifier si le nom contient un mot-cl√© de la cat√©gorie
                    if (!usedPrestationIds.has(prestationId)) {
                        const matchesCategory = keywords.some(keyword => nom.includes(keyword));
                        if (matchesCategory) {
                            categoryItems.push(prestation);
                            usedPrestationIds.add(prestationId);
                        }
                    }
                });

                // Ajouter la cat√©gorie si elle a des prestations
                if (categoryItems.length > 0) {
                    html += `<optgroup label="${categoryName}">`;
                    categoryItems.forEach(prestation => {
                        html += `<option value="${prestation[0]}" data-prix="${prestation[3]}" data-unite="${prestation[2]}">${prestation[1]} - ${prestation[3]} ‚Ç¨/${prestation[2]}</option>`;
                    });
                    html += '</optgroup>';
                }
            }

            // Ajouter les prestations non class√©es dans "AUTRES"
            const uncategorizedItems = prestationsTypes.filter(prestation =>
                !usedPrestationIds.has(prestation[0])
            );

            if (uncategorizedItems.length > 0) {
                html += `<optgroup label="üì¶ AUTRES">`;
                uncategorizedItems.forEach(prestation => {
                    html += `<option value="${prestation[0]}" data-prix="${prestation[3]}" data-unite="${prestation[2]}">${prestation[1]} - ${prestation[3]} ‚Ç¨/${prestation[2]}</option>`;
                });
                html += '</optgroup>';
            }

            return html;
        }

        function addPrestation() {
            const container = document.getElementById('prestations-container');
            const prestationId = ++prestationCounter;

            const prestationHtml = `
                <div class="prestation-row" id="prestation-${prestationId}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0 text-primary">Prestation #${prestationId}</h6>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removePrestation(${prestationId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Type de prestation</label>
                            <select class="form-select" onchange="updatePrestationPrice(${prestationId})" id="type-${prestationId}">
                                ${getOptGroupsHTML()}
                            </select>

                            <!-- Champs personnalis√©s cach√©s par d√©faut -->
                            <div class="custom-fields" id="custom-fields-${prestationId}" style="display: none;">
                                <div class="row mt-2">
                                    <div class="col-md-8">
                                        <label class="form-label">Nom de la prestation</label>
                                        <input type="text" class="form-control" id="custom-name-${prestationId}"
                                               placeholder="Ex: Pose carrelage sp√©cial"
                                               onchange="updateCustomDescription(${prestationId})">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Unit√©</label>
                                        <input type="text" class="form-control" id="custom-unit-${prestationId}"
                                               placeholder="m¬≤, unit√©, forfait..."
                                               onchange="updateCustomDescription(${prestationId})">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label">Quantit√©</label>
                            <input type="number" class="form-control" id="quantite-${prestationId}" value="1" min="0.1" step="0.1" onchange="calculatePrestation(${prestationId})">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label">Prix unitaire</label>
                            <input type="number" class="form-control" id="prix-${prestationId}" step="0.01" onchange="calculatePrestation(${prestationId})">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-9">
                            <label class="form-label">Description personnalis√©e</label>
                            <input type="text" class="form-control" id="description-${prestationId}" placeholder="Description d√©taill√©e...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Total</label>
                            <div class="input-group">
                                <input type="text" class="form-control fw-bold" id="total-${prestationId}" readonly>
                                <span class="input-group-text">‚Ç¨</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', prestationHtml);
        }

        function removePrestation(id) {
            document.getElementById(`prestation-${id}`).remove();
            calculateTotals();
        }

        function updatePrestationPrice(id) {
            const select = document.getElementById(`type-${id}`);
            const prixInput = document.getElementById(`prix-${id}`);
            const descInput = document.getElementById(`description-${id}`);

            if (select.value === 'custom') {
                // Mode prestation personnalis√©e
                toggleCustomMode(id, true);
                prixInput.value = '';
                descInput.value = '';
                calculatePrestation(id);
            } else if (select.value) {
                // Mode prestation pr√©d√©finie
                toggleCustomMode(id, false);
                const option = select.selectedOptions[0];
                prixInput.value = option.dataset.prix;
                if (!descInput.value) {
                    descInput.value = option.text;
                }
                calculatePrestation(id);
            } else {
                // Aucune s√©lection
                toggleCustomMode(id, false);
                prixInput.value = '';
                descInput.value = '';
            }
        }

        function toggleCustomMode(id, isCustom) {
            const customFields = document.getElementById(`custom-fields-${id}`);
            const select = document.getElementById(`type-${id}`);

            if (isCustom) {
                customFields.style.display = 'block';
                select.style.display = 'none';
            } else {
                customFields.style.display = 'none';
                select.style.display = 'block';
            }
        }

        function updateCustomDescription(id) {
            const customName = document.getElementById(`custom-name-${id}`).value;
            const customUnit = document.getElementById(`custom-unit-${id}`).value;
            const descInput = document.getElementById(`description-${id}`);

            if (customName && customUnit) {
                descInput.value = `${customName} - Prix par ${customUnit}`;
            } else if (customName) {
                descInput.value = customName;
            }
        }

        function calculatePrestation(id) {
            const quantite = parseFloat(document.getElementById(`quantite-${id}`).value) || 0;
            const prix = parseFloat(document.getElementById(`prix-${id}`).value) || 0;
            const total = quantite * prix;

            document.getElementById(`total-${id}`).value = total.toFixed(2);
            calculateTotals();
        }

        function calculateTotals() {
            let totalHT = 0;

            document.querySelectorAll('[id^="total-"]').forEach(input => {
                if (input.id.startsWith('total-') && input.id !== 'total-ht' && input.id !== 'total-tva' && input.id !== 'total-ttc') {
                    totalHT += parseFloat(input.value) || 0;
                }
            });

            const tva = totalHT * 0.20;
            const totalTTC = totalHT + tva;

            document.getElementById('total-ht').textContent = totalHT.toFixed(2) + ' ‚Ç¨';
            document.getElementById('total-tva').textContent = tva.toFixed(2) + ' ‚Ç¨';
            document.getElementById('total-ttc').textContent = totalTTC.toFixed(2) + ' ‚Ç¨';

            updateResume();
        }

        function updateResume() {
            const resumeContainer = document.getElementById('resume-prestations');
            const prestations = [];

            document.querySelectorAll('[id^="prestation-"]').forEach(div => {
                const id = div.id.split('-')[1];
                const description = document.getElementById(`description-${id}`)?.value;
                const total = document.getElementById(`total-${id}`)?.value;

                if (description && total && parseFloat(total) > 0) {
                    prestations.push({
                        description: description.substring(0, 30) + (description.length > 30 ? '...' : ''),
                        total: parseFloat(total)
                    });
                }
            });

            if (prestations.length === 0) {
                resumeContainer.innerHTML = '<p class="text-muted text-center"><i class="fas fa-info-circle me-1"></i>Ajoutez des prestations pour voir le r√©sum√©</p>';
            } else {
                const resumeHtml = prestations.map(p =>
                    `<div class="d-flex justify-content-between small mb-1">
                        <span>${p.description}</span>
                        <strong>${p.total.toFixed(2)} ‚Ç¨</strong>
                    </div>`
                ).join('');
                resumeContainer.innerHTML = resumeHtml;
            }
        }

        function loadDemo() {
            // Nettoyer le formulaire
            document.getElementById('devisForm').reset();
            document.getElementById('prestations-container').innerHTML = '';
            prestationCounter = 0;

            // Remplir avec des donn√©es de d√©monstration
            document.getElementById('prenom').value = 'Jean';
            document.getElementById('nom').value = 'Martin';
            document.getElementById('adresse').value = '123 Rue des Fleurs\n75001 Paris';
            document.getElementById('telephone').value = '01 23 45 67 89';
            document.getElementById('email').value = 'jean.martin@email.com';

            // Ajouter quelques prestations d'exemple
            addPrestation();
            document.getElementById('type-1').selectedIndex = 1; // Ma√ßonnerie
            updatePrestationPrice(1);
            document.getElementById('quantite-1').value = '25';
            calculatePrestation(1);

            addPrestation();
            document.getElementById('type-2').selectedIndex = 2; // Plomberie
            updatePrestationPrice(2);
            document.getElementById('quantite-2').value = '1';
            calculatePrestation(2);

            addPrestation();
            document.getElementById('type-3').selectedIndex = 4; // Peinture
            updatePrestationPrice(3);
            document.getElementById('quantite-3').value = '50';
            calculatePrestation(3);
        }

        // Variables globales pour les templates
        let emailTemplates = {};

        // Charger les templates email
        async function loadEmailTemplates() {
            try {
                const response = await fetch('/api/email-templates');
                emailTemplates = await response.json();
            } catch (error) {
                console.error('Erreur chargement templates:', error);
            }
        }

        // Pr√©visualiser un template
        async function previewTemplate() {
            const templateId = document.getElementById('email-template').value;
            const template = emailTemplates[templateId];

            if (!template) {
                await loadEmailTemplates();
                return previewTemplate();
            }

            // Donn√©es d'exemple
            const sampleData = {
                prenom: document.getElementById('prenom').value || 'Jean',
                nom: document.getElementById('nom').value || 'Martin',
                numero: 'DEV-2025-001',
                montant: '2 450.00',
                date: new Date().toLocaleDateString('fr-FR'),
                date_signature: new Date().toLocaleDateString('fr-FR'),
                lien_signature: `${window.location.origin}/signature/1`
            };

            // Remplacer les variables dans le template
            let subject = template.subject;
            let body = template.body;

            for (const [key, value] of Object.entries(sampleData)) {
                const regex = new RegExp(`{${key}}`, 'g');
                subject = subject.replace(regex, value);
                body = body.replace(regex, value);
            }

            // Afficher dans le modal
            document.getElementById('preview-subject').textContent = subject;
            document.getElementById('preview-body').textContent = body;

            // Ouvrir le modal
            new bootstrap.Modal(document.getElementById('templateModal')).show();
        }

        // Obtenir le template format√©
        function getFormattedTemplate(templateId, clientData, devisData) {
            const template = emailTemplates[templateId];
            if (!template) return null;

            const data = {
                prenom: clientData.prenom,
                nom: clientData.nom,
                numero: devisData.numero,
                montant: devisData.total_ttc.toFixed(2),
                date: new Date().toLocaleDateString('fr-FR'),
                date_signature: new Date().toLocaleDateString('fr-FR'),
                lien_signature: `${window.location.origin}/signature/${devisData.id}`
            };

            let subject = template.subject;
            let body = template.body;

            for (const [key, value] of Object.entries(data)) {
                const regex = new RegExp(`{${key}}`, 'g');
                subject = subject.replace(regex, value);
                body = body.replace(regex, value);
            }

            return { subject, body };
        }

        // Fonction d'envoi d'email avec EmailJS
        async function sendEmailWithPDF(clientData, pdfUrl, devisData) {
            try {
                // Obtenir le template s√©lectionn√©
                const templateId = document.getElementById('email-template').value;
                const templateFormatted = getFormattedTemplate(templateId, clientData, devisData);

                if (!templateFormatted) {
                    throw new Error('Template non trouv√©');
                }

                const emailParams = {
                    to_email: clientData.email,
                    to_name: `${clientData.prenom} ${clientData.nom}`,
                    client_name: `${clientData.prenom} ${clientData.nom}`,
                    devis_numero: devisData.numero,
                    pdf_link: window.location.origin + pdfUrl,
                    company_name: "NFS B√ÇTIMENT",
                    subject: templateFormatted.subject,
                    message: templateFormatted.body,
                    template_name: emailTemplates[templateId].name
                };

                // Envoyer l'email via EmailJS
                const response = await emailjs.send(
                    'YOUR_SERVICE_ID',      // Service ID √† configurer
                    'YOUR_TEMPLATE_ID',     // Template ID √† configurer
                    emailParams
                );

                return response;
            } catch (error) {
                console.error('Erreur envoi email:', error);
                throw error;
            }
        }

        async function generateDevis() {
            const btnGenerate = document.getElementById('btn-generate');
            btnGenerate.disabled = true;
            btnGenerate.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>G√©n√©ration en cours...';

            try {
                // Collecter les donn√©es du formulaire
                const clientData = {
                    prenom: document.getElementById('prenom').value,
                    nom: document.getElementById('nom').value,
                    adresse: document.getElementById('adresse').value,
                    telephone: document.getElementById('telephone').value,
                    email: document.getElementById('email').value
                };

                // Debug pour voir les donn√©es collect√©es
                console.log('Donn√©es client collect√©es:', clientData);

                const prestationsData = [];
                document.querySelectorAll('[id^="prestation-"]').forEach(div => {
                    const id = div.id.split('-')[1];
                    const select = document.getElementById(`type-${id}`);
                    let description = '';

                    // V√©rifier si c'est une prestation personnalis√©e
                    if (select.value === 'custom') {
                        const customName = document.getElementById(`custom-name-${id}`)?.value || '';
                        const customUnit = document.getElementById(`custom-unit-${id}`)?.value || '';
                        if (customName && customUnit) {
                            description = `${customName} (${customUnit})`;
                        }
                    } else {
                        description = document.getElementById(`description-${id}`)?.value;
                    }

                    const quantite = parseFloat(document.getElementById(`quantite-${id}`)?.value);
                    const prix = parseFloat(document.getElementById(`prix-${id}`)?.value);
                    const total = parseFloat(document.getElementById(`total-${id}`)?.value);

                    // V√©rification plus pr√©cise : description non vide, quantit√© et prix > 0
                    if (description && description.trim() !== '' && quantite > 0 && prix > 0) {
                        prestationsData.push({
                            description: description.trim(),
                            quantite,
                            prix_unitaire: prix,
                            total
                        });
                    }
                });

                console.log('Prestations collect√©es:', prestationsData); // Debug

                // Collecter les donn√©es de paiement
                const paymentData = {
                    mode: document.getElementById('payment-mode').value,
                    deadline: document.getElementById('payment-deadline').value
                };

                console.log('Donn√©es paiement collect√©es:', paymentData); // Debug
                console.log('Mode s√©lectionn√©:', document.getElementById('payment-mode').value);
                console.log('√âch√©ance s√©lectionn√©e:', document.getElementById('payment-deadline').value);

                // Validation email si envoi activ√©
                const sendEmail = document.getElementById('send-email').checked;
                if (sendEmail && !clientData.email) {
                    alert('‚ö†Ô∏è Veuillez renseigner l\'email du client pour l\'envoi automatique.');
                    return;
                }

                // Validation
                if (!clientData.nom || !clientData.prenom || !clientData.adresse) {
                    alert('Veuillez remplir les informations client obligatoires.');
                    return;
                }

                if (prestationsData.length === 0) {
                    alert('Veuillez ajouter au moins une prestation.');
                    return;
                }

                // Envoyer √† l'API
                const response = await fetch('/api/generate-devis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client: clientData,
                        prestations: prestationsData,
                        payment: paymentData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // T√©l√©charger le PDF
                    window.open(result.pdf_url, '_blank');

                    let successMessage = '‚úÖ Devis g√©n√©r√© avec succ√®s !';

                    // Envoyer par email si activ√©
                    if (sendEmail && clientData.email) {
                        try {
                            btnGenerate.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Envoi par email...';

                            const devisNumero = `DEV-${new Date().toISOString().slice(0, 10).replace(/-/g, '')}-${result.devis_id.toString().padStart(3, '0')}`;

                            // Cr√©er les donn√©es du devis pour le template
                            const devisData = {
                                id: result.devis_id,
                                numero: devisNumero,
                                total_ttc: prestationsData.reduce((total, p) => total + (p.quantite * p.prix_unitaire * 1.2), 0)
                            };

                            // Envoyer par email avec le nouveau syst√®me
                            const emailResponse = await fetch('/api/send-devis-email', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    email: clientData.email,
                                    devis: {
                                        nom: clientData.nom,
                                        adresse: clientData.adresse,
                                        telephone: clientData.telephone,
                                        email: clientData.email,
                                        prestations: prestationsData,
                                        total: prestationsData.reduce((total, p) => total + (p.quantite * p.prix_unitaire * 1.2), 0)
                                    }
                                })
                            });

                            const emailResult = await emailResponse.json();

                            if (emailResult.success) {
                                successMessage += '\nüìß Email envoy√© avec succ√®s !';
                            } else if (emailResult.email_enabled) {
                                successMessage += `\n‚ö†Ô∏è Erreur email: ${emailResult.message}`;
                            } else {
                                successMessage += '\nüìß Email non configur√© (mot de passe EMAIL_PASSWORD requis)';
                            }

                        } catch (emailError) {
                            console.error('Erreur email:', emailError);
                            successMessage += '\n‚ö†Ô∏è Erreur lors de l\'envoi de l\'email, mais le PDF est g√©n√©r√©.';
                        }
                    }

                    // Message de succ√®s final
                    alert(successMessage);

                } else {
                    alert('‚ùå Erreur lors de la g√©n√©ration: ' + result.error);
                }

            } catch (error) {
                alert('‚ùå Erreur r√©seau: ' + error.message);
                console.error('Erreur:', error);
            } finally {
                btnGenerate.disabled = false;
                btnGenerate.innerHTML = '<i class="fas fa-file-pdf me-2"></i>G√©n√©rer & Envoyer le Devis';
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            // Charger les templates email
            loadEmailTemplates();

            // G√©rer l'affichage de la section template
            const sendEmailCheckbox = document.getElementById('send-email');
            const templateSection = document.getElementById('email-template-section');

            sendEmailCheckbox.addEventListener('change', function () {
                templateSection.style.display = this.checked ? 'block' : 'none';
            });

            // Ajouter une prestation par d√©faut
            addPrestation();
        });
    </script>
</body>

</html>